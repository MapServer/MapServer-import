# compiler flags 
CC=@CC@
CFLAGS=@CFLAGS@ -ansi -pedantic -Wall
PGFLAGS=-lpq -I`pg_config --includedir` -L`pg_config --libdir`
XMLFLAGS=-lxml2 `xml2-config --cflags` 

# install path
PREFIX=@prefix@

SRC = $(wildcard src/*/*.c)

all: @API@
	$(CC) $(CFLAGS) $(PGFLAGS) $(XMLFLAGS) $(SRC) -o tinyows

api:
	@echo  "ows_api.h generation"
	@cat $(SRC) | indent -nbfda -nbfde -npsl -l1000 > .foo.c
	@ctags --c-kinds=f -o .tags .foo.c
	@echo "/* This file is generated by Makefile, don't edit */" > src/ows_api.h
	@cat .tags | sed -e "/static/d" -e "/!_/d" -e "s/\(.*\)\/^\(.*\)/\2/" -e "s/\(.*\))\(.*\)/\1);/" >> src/ows_api.h
	@rm -f .foo.c .tags


svn-clean: clean doc-clean
	@find . -name '*~' -exec rm {} \;
	@rm -f src/ows_api.h configure

clean: 
	@rm -f tinyows ERROR Makefile src/ows_define.h


install:
	mkdir --parents $(PREFIX)/tinyows
	cp tinyows $(PREFIX)/tinyows/
	cp -rf schema $(PREFIX)/tinyows/
	cp -i config.xml $(PREFIX)/tinyows/


doc-clean:
	@rm -rf doc/doxygen

doxygen: clean-doc
	@(which doxygen 2> /dev/null > /dev/null	\
	&& mkdir -p doc/doxygen				\
	&& doxygen doc/Doxyfile				\
	) || echo "doxygen seems not installed"

valgrind:
	@(which valgrind 2> /dev/null > /dev/null	\
	&& rm -f ERROR					\
	&& test/wfs_get_feature 1			\
	&& test/wfs_get_capabilities 1			\
	&& test/wfs_describe 1				\
	&& test/wms_get_capabilities 1			\
	&& test/wms_get_map 1				\
	&& test/wfs_transaction 1			\
	&& test/wfs_lock_feature 1			\
	&& test/wfs_get_feature_with_lock 1		\
	) || echo "valgrind seems not installed"


indent:
	@(which indent 2> /dev/null > /dev/null \
	&& indent -nbad -bap -bbo -nbc -bli0 -c33 -cd33 -ncdb -nce -nlp -ci3 -cli0 -cp33 -cs -d0 -di1 -nfc1 -nfca -hnl -ts4 -i4 -ip0 -npcs -nprs -npsl -saf -sai -saw -nsc -nsob -nss -nbfda -nbfde -npsl -l75 $(SRC) \
	&& find . -name '*~' -exec rm {} \;    \
	) || echo "indent seems not installed"

splint:
	@(which splint 2> /dev/null > /dev/null \
	&& splint -mustfreeonly -kepttrans -nullderef -compdestroy -mustfreefresh -temptrans -usereleased -compdef -observertrans -statictrans -booltype bool $(PGFLAGS) $(XMLFLAGS) $(SRC) \
	) || echo "splint seems not installed"
