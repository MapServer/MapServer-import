<?xml version="1.0" standalone="no"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
          "http://mapserver.gis.umn.edu/mdp/docbkx412/docbookx.dtd">
<!-- $Id$ -->
<article>
	<articleinfo>
		<title>Mapserver Map Context HOWTO - Version 4.0</title>
		<author>
			<firstname>Jeff</firstname>
			<surname>McKenna</surname>
			<affiliation>
				<orgname>DM Solutions Group Inc.</orgname>
				<address>
					<email>mckenna@dmsolutions.ca</email>
				</address>
			</affiliation>
		</author>
		<date>2003-07-21</date>
		<abstract>
			<!-- a short description of the contents of the doc -->
			<para>
                 This document describes the procedures for the creation of a map context document with MapServer.  
      </para>
			<para>Last Updated: 07/21/2003</para>
		</abstract>
	</articleinfo>
	<sect1 id="intro">
		<title>Introduction</title>
		<para>
		The term 'map context' comes from the Open GIS Constortium's (OGC) <ulink url="http://www.opengis.org/techno/specs/03-036r2.pdf">Web Map Context 			Specification v1.0.0</ulink>, which coincides with the OGC <ulink url="http://www.opengis.org/techno/specs/01-068r3.pdf">Web Map Server
		Interfaces Implementation Specification (WMS) v1.1.1</ulink>.  A map context is a XML document that describes the appearance of layers from one or more WMS 		servers, and can be transferred 	between clients while maintaining startup views, the state of the view (and its layers), and storing additional layer information.
    		</para>
		<para>
      		Support for OGC Web Map Context hsa been added to MapServer in version 3.7/4.0.  This allows client applications to load and save a map configuration
		in a standard XML format.
   		 </para>
		<para>
		MapServer can read context documents of versions 0.1.2, 0.1.4, 0.1.7, &amp; 1.0.0 and can export contents in versions 0.1.4, 0.1.7, &amp; 1.0.0.
		</para>
		<para>
             This document assumes that you are already familiar with certain aspects of MapServer:
          </para>
		<itemizedlist>
			<listitem>
				<para>
                      		MapServer application development and setting up .map files. 
                		</para>
			</listitem>
			<listitem>
				<para>
          				Familiarity with the WMS spec would be an asset. Please see the following section for links to associated sources.        							</para>
			</listitem>
		</itemizedlist>
		<sect2 id="links">
			<title>Links to WMS / Map Context Related Information</title>
			<itemizedlist>
				<listitem>
					<para>
            The Mapserver Map Context Wiki:
            <ulink url="http://mapserver.gis.umn.edu/cgi-bin/wiki.pl?MapContextHowto">
            http://mapserver.gis.umn.edu/cgi-bin/wiki.pl?MapContextHowto</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            The Mapserver WMS Client HOWTO:
            <ulink url="http://mapserver.gis.umn.edu/doc/wms-client-howto.html">
            http://mapserver.gis.umn.edu/doc/wms-client-howto.html</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            Open GIS Consortium (OGC) Home Page:
              <ulink url="http://www.opengis.org/">http://www.opengis.org/</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            WMS 1.1.1 specification:
              <ulink url="http://www.opengis.org/techno/specs/01-068r3.pdf">
            http://www.opengis.org/techno/specs/01-068r3.pdf</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            Map Context 1.0.0 specification:
              <ulink url="http://www.opengis.org/techno/specs/03-036r2.pdf">
            http://www.opengis.org/techno/specs/03-036r2.pdf</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            WMS-Dev mailing list and archive:
              <ulink url="http://www.intl-interfaces.net/mailman/listinfo/wms-dev">
            http://www.intl-interfaces.net/mailman/listinfo/wms-dev</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            WMS FAQ:
              <ulink url="http://www.intl-interfaces.net/cookbook/WMS/faq/faqw.py?req=home">
            http://www.intl-interfaces.net/cookbook/WMS/faq/faqw.py?req=home</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            WMS XML Capabilities validator:
              <ulink url="http://www.digitalearth.gov/wmt/xml/validator.html">
            http://www.digitalearth.gov/wmt/xml/validator.html</ulink>
					</para>
				</listitem>
				<listitem>
					<para>
            WMS Cookbook:
              <ulink url="http://www.intl-interfaces.net/cookbook/WMS/">
            http://www.intl-interfaces.net/cookbook/WMS/</ulink>
					</para>
				</listitem>
			</itemizedlist>
		</sect2>
	</sect1>
	<!-- Section1: Implementation-->
	<sect1 id="implementation">
		<title>Implementing a Web Map Context</title>
		<sect2 id="build">
			<title>Special Build Considerations</title>
			<para>
				Map Context support requires PROJ4, GDAL/OGR and PHP support libraries.
      			</para>
			<para>
				Build/install the above libraries on your system adn then build MapServer with
				the '--with-wmsclient --with-proj --with-php' configure options.
			</para>
		</sect2>
		<sect2 id="mapfile">
			<title>Map Context Mapfile</title>
			<para>
			  	A map context document can ONLY contain WMS layers (e.g. CONNECTIONTYPE WMS).  
				Please refer to the <ulink url="http://mapserver.gis.umn.edu/doc/wms-client-howto.html">
				MapServer WMS Client HOWTO</ulink> for more information on declaring WMS layers.
     	 		</para>
			<sect3 id="metadata">
				<title>MapFile Metadata</title>
				<para>
						The following mapfile metadata are used by MapServer to handle map context information:
      					</para>
				<sect4 id="web">
					<title>Web Object Metadata</title>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_abstract</emphasis> : A blurb of text providing more information about the WMS server.											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_address</emphasis> : (Optional, if provided must also then provide wms_addresstype, wms_city,
								wms_stateorprovince, wms_postcode, and wms_country)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_addresstype</emphasis> : (Optional, if provided must also then provide wms_address, wms_city,
								wms_stateorprovince, wms_postcode, and wms_country)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_city</emphasis> : (Optional, if provided must also then provide wms_address, wms_addresstype,
								wms_stateorprovince, wms_postcode, and wms_country)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactelectronicmailaddress</emphasis> : Optional contact Email address. 												</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactfacsimiletelephone</emphasis> : Optional contact facsimile telephone number. 											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactorganization</emphasis> : (Optional)																</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactperson</emphasis> : (Optional)																</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactposition</emphasis> : (Optional)																</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_contactvoicetelephone</emphasis> : Optional contact voice telephone number. 												</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_context_fid</emphasis> : the feature id of the context.  Set to 0 when saving
								if not specified.
							</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_context_version</emphasis> : the version of the map context specification.
							</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_country</emphasis> : (Optional, if provided must also then provide wms_address, wms_city,
								wms_stateorprovince, wms_postcode, and wms_addresstype)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_dataurl</emphasis> : The URL to the data server.														</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_keywordlist</emphasis> : A comma-separated list of keywords or keyword phrases to help catalog searching.							</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_logourl</emphasis> : Four space-separated elements: image width, height, format, and the URL.											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_postcode</emphasis> : (Optional, if provided must also then provide wms_address, wms_city,
								wms_stateorprovince, wms_addresstype, and wms_country)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_stateorprovince</emphasis> : (Optional, if provided must also then provide wms_address, wms_city,
								wms_addresstype, wms_postcode, and wms_country)															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_title</emphasis> : A human-readable name for this Layer (this metadata does not exist beyond 
								version 0.1.4)
							</para>
						</listitem>
					</itemizedlist>
				</sect4>
				<sect4 id="layer">
					<title>Layer Object Metadata</title>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_abstract</emphasis> : A blurb of text providing more information about the WMS server.											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_format</emphasis> : Current format used.															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_formatlist</emphasis> : List of available formats for this layer.													</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_name</emphasis> : Name of the WMS layer on the server. 													</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_onlineresource</emphasis> : URL to access the server.														</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_server_version</emphasis> : The version of the web map server specification.											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_stylelist</emphasis> : Current style used.															</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_style_%s_legendurl</emphasis> : Location of an image describing the style.  This metadata contains
								4 elements separated by spaces: width of the image, height, format, and the url.  %s = the name of the style.										</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_style_%s_sld</emphasis> : URL to the SLD document of this style. %s = the name of the style.											</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_style_%s_title</emphasis> : Title of the layer. %s = the name of the style.												</para>
						</listitem>
					</itemizedlist>
					<itemizedlist>
						<listitem>
							<para>
								<emphasis>wms_title</emphasis> : A human-readable name for this Layer.														</para>
						</listitem>
					</itemizedlist>
				</sect4>
			</sect3>
		</sect2>
		<sect2 id="testing">
			<title>Testing Map Context Support</title>
			<orderedlist numeration="lowerroman">
				<listitem>
					<para>
					The first thing to do is to save your mapfile using the saveMapContext function available from the phpmapscript library (see the
					<ulink url="http://mapserver.gis.umn.edu/doc/phpmapscript-class-guide.html#MapObj">Map Object functions</ulink>).	An example
					script is shown below:
				</para>
				<programlisting>
	&lt;?php
	dl("php_mapscript_40.dll");
	$oMap = ms_newMapObj("gmap_wms_context.map");
	$oMap->saveMapContext("gmap_wms_context_output.xml");
	?&gt; 				
				</programlisting>
				</listitem>
				<listitem>
					<para>
					Scan the XML output to look for &lt;!-- WARNING: ... --&gt; comments.  Then make the necessary changes to fix every warning
					that you encounter.  At the end of this you should have a mapfile compatible with the Map Context specification.
				</para>
				</listitem>
				<listitem>
					<para>
					Now you can load your new Map Context document into an application using the loadMapContext function from the phpmapscript 
					library (see the <ulink url="http://mapserver.gis.umn.edu/doc/phpmapscript-class-guide.html#MapObj">Map Object functions</ulink>).
					Look for the free application <ulink url="http://www.maptools.org/maplab/index.phtml">MapLab</ulink> to be able to (in the near future) load 
					MapContext docs from other servers and save a mapfile into a Map Context document.
				</para>
				</listitem>
			</orderedlist>
		</sect2>
		<sect2 id="example">
			<title>Sample Map Context Document</title>
			<para>
				The following is a sample Map Context document:
			</para>
			<programlisting>
&lt;?xml version='1.0' encoding="ISO-8859-1" standalone="no" ?&gt;
&lt;ViewContext version="1.0.0" id="DEMO" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.opengis.net/context" xsi:schemaLocation="http://www.opengis.net/context http://schemas.opengis.net/context/1.0.0/context.xsd"&gt;
  &lt;General&gt;
    &lt;Window width="400" height="300"/&gt;
    &lt;!-- Bounding box corners and spatial reference system --&gt;
    &lt;BoundingBox SRS="EPSG:42304" minx="-2610230.000000" miny="-905635.000000" maxx="2636310.000000" maxy="3031130.000000"/&gt;
    &lt;!-- Title of Context --&gt;
    &lt;Title&gt;my test&lt;/Title&gt;
  &lt;/General&gt;
  &lt;!-- LayerList of Layer elements
       - implied order: bottom To Top
       first Layer element is bottom most layer in map view
       last Layer elements is op most layer in map view
  --&gt;
  &lt;LayerList&gt;
    &lt;Layer queryable="0" hidden="0"&gt;
      &lt;Server service="WMS" version="1.1.1" title="Oceans/Seas"&gt;
        &lt;OnlineResource xlink:type="simple" xlink:href="http://ceoware2.ccrs.nrcan.gc.ca/cubewerx/cubeserv/cubeserv.cgi?"/&gt;
      &lt;/Server&gt;
      &lt;Name&gt;OCEANSEA_BND_1M:Foundation&lt;/Name&gt;
      &lt;Title&gt;Oceans/Seas&lt;/Title&gt;
      &lt;Abstract&gt;VRF Narrative Table for 'Oceans/Seas':\n\n&lt;P&gt;In coastal area, points of change from ocean/sea areas (BA040) to inland water\nareas (BH000) were taken from Digital Chart of the World, edition 1, July 1992\nexcept when it was determined that the point of change was implemented too far\ninland.  In these cases, cartographic judgement was used to establish the point\nof change.\n&lt;/Abstract&gt;
      &lt;SRS&gt;EPSG:4326 AUTO:42001 AUTO:42002 AUTO:42003 AUTO:42004EPSG:32750 EPSG:32751 EPSG:32752 EPSG:32753 EPSG:32754 EPSG:32755 EPSG:32756 EPSG:32757 EPSG:32758 EPSG:32759 EPSG:32760 EPSG:41001 EPSG:42101 EPSG:42102 EPSG:42103 EPSG:42104 EPSG:42105 EPSG:42106 EPSG:42301 EPSG:42302 EPSG:42303 EPSG:42304 EPSG:42305 EPSG:42306 EPSG:42307 EPSG:42308 EPSG:42309 EPSG:42310 EPSG:100001.................&lt;/SRS&gt;
      &lt;FormatList&gt;
        &lt;Format&gt;image/png  image/tiff  image/gif  image/jpeg  image/ppm  application/x-cubestor-wkb  application/x-cubestor-gml.1  application/x&lt;/Format&gt;
      &lt;/FormatList&gt;
      &lt;StyleList&gt;
        &lt;Style current="1"&gt;
          &lt;Name&gt;0xb8d8f6&lt;/Name&gt;
          &lt;Title&gt;0xb8d8f6&lt;/Title&gt;
          &lt;LegendURL width="16" height="16" format="image/gif"&gt;
            &lt;OnlineResource xlink:type="simple" xlink:href="http://ceoware2.ccrs.nrcan.gc.ca/cubewerx/cubeserv/cubeserv.cgi?VERSION=1.1.1&amp;REQUEST=GetLegendGraphic&amp;LAYER=OCEANSEA_BND_1M%3AFoundation&amp;SPATIAL_TYPE=POLYGON&amp;STYLE=0xb8d8f6&amp;FORMAT=image%2Fgif&amp;SIMPLE=TRUE"/&gt;
          &lt;/LegendURL&gt;
        &lt;/Style&gt;
      &lt;/StyleList&gt;
    &lt;/Layer&gt;
    &lt;Layer queryable="0" hidden="0"&gt;
      &lt;Server service="WMS" version="1.1.1" title="Political Boundaries"&gt;
        &lt;OnlineResource xlink:type="simple" xlink:href="http://ceoware2.ccrs.nrcan.gc.ca/cubewerx/cubeserv/cubeserv.cgi?"/&gt;
      &lt;/Server&gt;
      &lt;Name&gt;POLBNDL_BND_1M:Foundation&lt;/Name&gt;
      &lt;Title&gt;Political Boundaries&lt;/Title&gt;
      &lt;SRS&gt;EPSG:4326 AUTO:42001 AUTO:42002 AUTO:42003 AUTO:EPSG:42102 EPSG:42103 EPSG:42104 EPSG:42105 EPSG:42106 EPSG:42301 EPSG:42302 EPSG:42303 EPSG:42304 EPSG:42305 EPSG:42306 EPSG:42307 EPSG:42308 EPSG:42309 EPSG:42310 EPSG:100001...........&lt;/SRS&gt;
      &lt;FormatList&gt;
        &lt;Format&gt;image/png  image/tiff  image/gif  image/jpeg  image/ppm  application/x-cubestor-wkb  application/x-cubestor-gml.1  application/x&lt;/Format&gt;
      &lt;/FormatList&gt;
      &lt;StyleList&gt;
        &lt;Style current="1"&gt;
          &lt;Name&gt;black&lt;/Name&gt;
          &lt;Title&gt;black&lt;/Title&gt;
          &lt;LegendURL width="16" height="16" format="image/gif"&gt;
            &lt;OnlineResource xlink:type="simple" xlink:href="http://ceoware2.ccrs.nrcan.gc.ca/cubewerx/cubeserv/cubeserv.cgi?VERSION=1.1.1&amp;REQUEST=GetLegendGraphic&amp;LAYER=POLBNDL_BND_1M%3AFoundation&amp;SPATIAL_TYPE=LINE&amp;STYLE=black&amp;FORMAT=image%2Fgif&amp;SIMPLE=TRUE"/&gt;
          &lt;/LegendURL&gt;
        &lt;/Style&gt;
      &lt;/StyleList&gt;
    &lt;/Layer&gt;
  &lt;/LayerList&gt;
&lt;/ViewContext&gt;
			</programlisting>
		</sect2>
	</sect1>
	<sect1 id="todo">
		<title>TODO</title>
		<sect2 id="before">
			<title>Before 4.0 Release</title>
			<itemizedlist>
				<listitem>
					<para>
						Need to validate request results against the corresponding XML schema files.
						</para>
				</listitem>
			</itemizedlist>
		</sect2>
		<sect2 id="longterm">
			<title>Long term</title>
			<itemizedlist>
				<listitem>
					<para>
								Possibly add a configure option (--with-context).
							</para>
				</listitem>
			</itemizedlist>
		</sect2>
	</sect1>
	<sect1 id="FAQ">
		<title>FAQ / Common Problems</title>
		<para>None available at this time</para>
	</sect1>
	<!-- Section1: Document Info -->
	<sect1 id="docinfo">
		<title>About This Document</title>
		<sect2 id="copyright">
			<title>Copyright Information</title>
			<para>
                Copyright (c) 2003, Jeff McKenna, DM Solutions Group Inc.
      </para>
			<para>
                This documentation is covered by the same Open Source license as the
                MapServer software itself.  See MapServer's 
                <ulink url="http://mapserver.gis.umn.edu/license.html">License and 
                Credits</ulink> page for the complete text.
            </para>
		</sect2>
		<sect2 id="disclaimer">
			<title>Disclaimer</title>
			<para>
            No liability for the contents of this document can be accepted.
            Use the concepts, examples and other content at your own risk.
            As this is a new edition of this document, there may be errors
            and inaccuracies that may be damaging to your system.
            Although this is highly unlikely, the author(s) do not take any 
            responsibility for that:  proceed with caution.
                  </para>
		</sect2>
		<!-- Section2: feedback -->
		<sect2 id="feedback">
			<title>Feedback</title>
			<para>
            Send any comments or suggestions to the author.
        </para>
		</sect2>
	</sect1>
</article>
